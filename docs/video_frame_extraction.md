# Video Frame Extraction

## Overview

This document describes the automatic extraction of first and last frames from video clips generated by RunPod.

## Implementation

### Utility Function

**Location:** `videomerge/utils/video_frames.py`

The `extract_first_and_last_frames()` function extracts the first and last frames from a video file as PNG images using `ffmpeg`.

**Function Signature:**
```python
def extract_first_and_last_frames(
    video_path: Path,
    output_dir: Path,
) -> Tuple[Path, Path]
```

**Parameters:**
- `video_path`: Path to the video file (e.g., `000_c04213ad065847ca8097c4f541be3b8e.mp4`)
- `output_dir`: Directory where the PNG frames should be saved

**Returns:**
- Tuple of `(first_frame_path, last_frame_path)`

### Naming Convention

For a video file named `000_c04213ad065847ca8097c4f541be3b8e.mp4`, the extracted frames are named:
- First frame: `000_c04213ad065847ca8097c4f541be3b8e_first.png`
- Last frame: `000_c04213ad065847ca8097c4f541be3b8e_last.png`

### Storage Location

Extracted frames are stored in: `/data/shared/{run_id}/first_last/`

### Integration

The frame extraction is automatically triggered in the `RunPodComfyUIClient.download_outputs()` method whenever a video file is saved. This happens after:
1. Receiving the video from RunPod in base64 format
2. Decoding and saving the MP4 file to the shared network drive
3. Extracting the first and last frames to the `first_last` subdirectory

### Error Handling

If frame extraction fails (e.g., due to corrupted video or ffmpeg issues), the error is logged as a warning but does not prevent the video from being saved. This ensures that video generation workflows continue even if frame extraction encounters issues.

## Usage Example

```python
from pathlib import Path
from videomerge.utils.video_frames import extract_first_and_last_frames

video_path = Path("/data/shared/run_123/000_c04213ad065847ca8097c4f541be3b8e.mp4")
output_dir = Path("/data/shared/run_123/first_last")

first_frame, last_frame = extract_first_and_last_frames(video_path, output_dir)
print(f"First frame: {first_frame}")
print(f"Last frame: {last_frame}")
```

## Technical Details

### FFmpeg Commands

**First Frame Extraction:**
```bash
ffmpeg -hide_banner -loglevel error -y \
  -i video.mp4 \
  -vf 'select=eq(n\,0)' \
  -vframes 1 \
  output_first.png
```

**Last Frame Extraction:**
```bash
ffmpeg -hide_banner -loglevel error -y \
  -sseof -0.1 \
  -i video.mp4 \
  -update 1 \
  -frames:v 1 \
  output_last.png
```

The last frame extraction uses `-sseof -0.1` to seek to 0.1 seconds before the end of the video, which is more efficient than processing the entire video.
